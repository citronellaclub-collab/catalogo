<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Global Trade Link</title>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #1e1e1e;
  color: #f2f2f2;
}

header {
  background: #2c2c2c;
  padding: 10px 16px;
  border-bottom: 2px solid #333;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.token {
  color: #3dff7a;
  font-weight: bold;
}

.tabs {
  display: flex;
  background: #252525;
}

.tab {
  padding: 8px 14px;
  cursor: pointer;
  border-right: 1px solid #333;
}

.tab.active {
  background: #1e1e1e;
  border-bottom: 2px solid #3d7eff;
}

.view { display: none; padding: 12px; }
.view.active { display: block; }

input, button {
  width: 100%;
  margin-bottom: 6px;
  padding: 6px;
  background: #1a1a1a;
  border: 1px solid #444;
  color: #fff;
}

button {
  background: #3d7eff;
  cursor: pointer;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 12px;
}

/* ITEM */
.item {
  position: relative;
  height: 180px;
  border: 2px solid #3a3a3a;
  background: #2b2b2b;
  cursor: pointer;
  overflow: hidden;
}

.item img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.item-info {
  position: absolute;
  bottom: 0;
  width: 100%;
  background: rgba(0,0,0,0.7);
  padding: 6px;
  font-size: 12px;
}

/* DEV + MODAL */
.dev-panel, .modal {
  position: fixed;
  background: #252525;
  border: 2px solid #444;
  padding: 12px;
}

.dev-panel {
  right: 10px;
  bottom: 10px;
  width: 240px;
  display: none;
}

.modal {
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 260px;
  display: none;
}
</style>
</head>

<body>

<header>
  <strong>Global Trade Link</strong>
  <div>Tokens: <span id="tokenCount" class="token">0 游릭</span></div>
</header>

<div class="tabs">
  <div class="tab active" onclick="switchView('buscar', this)">Buscar</div>
  <div class="tab" onclick="switchView('publicar', this)">Publicar</div>
  <div class="tab" onclick="toggleDev()">Modo Dev</div>
</div>

<!-- BUSCAR -->
<div id="buscar" class="view active">
  <div class="grid" id="grid"></div>
</div>

<!-- PUBLICAR -->
<div id="publicar" class="view">
  <h3>Publicar Item</h3>
  <input id="pName" placeholder="Nombre">
  <input id="pPrice" type="number" placeholder="Precio (tokens)">
  <input id="pQty" type="number" placeholder="Cantidad">
  <input id="pImg" type="file" accept="image/*">
  <button onclick="publishItem()">Publicar</button>
</div>

<!-- DEV PANEL -->
<div class="dev-panel" id="devPanel">
  <h4>Editar Item</h4>
  <img id="devImg" style="width:100%;height:100px;object-fit:cover;margin-bottom:6px">
  <input id="editName">
  <input id="editPrice" type="number">
  <input id="editQty" type="number">
  <input id="editImg" type="file" accept="image/*">
  <button onclick="saveEdit()">Guardar Item</button>

  <hr>

  <h4>Tokens (Admin)</h4>
  <input id="tokenAmount" type="number" placeholder="+ o - tokens">
  <button onclick="modifyTokens()">Aplicar Tokens</button>
</div>

<!-- MODAL COMPRA -->
<div class="modal" id="buyModal">
  <h3 id="buyName"></h3>
  <input id="buyQty" type="number" min="1">
  <p>Total: <span id="buyTotal" class="token"></span></p>
  <button onclick="confirmBuy()">Confirmar</button>
  <button onclick="closeModal()">Cancelar</button>
</div>

<script>
let items = [];
let selectedIndex = null;
let buyIndex = null;
let tokens = 5000;

/* UTIL */
function fileToBase64(file, cb) {
  const r = new FileReader();
  r.onload = () => cb(r.result);
  r.readAsDataURL(file);
}

/* VISTAS */
function switchView(id, el) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  el.classList.add('active');
}

/* RENDER */
function render() {
  tokenCount.textContent = tokens + " 游릭";
  grid.innerHTML = "";

  items.forEach((item, i) => {
    const d = document.createElement("div");
    d.className = "item";
    d.innerHTML = `
      <img src="${item.img}">
      <div class="item-info">
        <strong>${item.name}</strong><br>
        <span class="token">${item.price} 游릭</span> | Stock: ${item.qty}
      </div>
    `;
    d.onclick = () => openBuy(i);
    d.oncontextmenu = e => {
      e.preventDefault();
      selectItem(i);
      toggleDev(true);
    };
    grid.appendChild(d);
  });
}

/* PUBLICAR */
function publishItem() {
  if (!pImg.files[0]) return alert("Selecciona imagen");
  fileToBase64(pImg.files[0], img => {
    items.push({
      name: pName.value,
      price: +pPrice.value,
      qty: +pQty.value,
      img
    });
    render();
  });
}

/* DEV */
function selectItem(i) {
  selectedIndex = i;
  const it = items[i];
  editName.value = it.name;
  editPrice.value = it.price;
  editQty.value = it.qty;
  devImg.src = it.img;
}

function saveEdit() {
  if (selectedIndex === null) return;
  const it = items[selectedIndex];
  it.name = editName.value;
  it.price = +editPrice.value;
  it.qty = +editQty.value;

  if (editImg.files[0]) {
    fileToBase64(editImg.files[0], img => {
      it.img = img;
      devImg.src = img;
      render();
    });
  } else render();
}

function modifyTokens() {
  tokens += Number(tokenAmount.value);
  tokenAmount.value = "";
  render();
}

function toggleDev(force) {
  devPanel.style.display =
    force || devPanel.style.display === "none" ? "block" : "none";
}

/* COMPRA */
function openBuy(i) {
  buyIndex = i;
  buyName.textContent = items[i].name;
  buyQty.value = 1;
  updateBuyTotal();
  buyModal.style.display = "block";
}

function updateBuyTotal() {
  buyTotal.textContent =
    buyQty.value * items[buyIndex].price + " 游릭";
}
buyQty.oninput = updateBuyTotal;

function confirmBuy() {
  const qty = +buyQty.value;
  const cost = qty * items[buyIndex].price;

  if (qty > items[buyIndex].qty) return alert("Stock insuficiente");
  if (cost > tokens) return alert("Tokens insuficientes");

  items[buyIndex].qty -= qty;
  tokens -= cost;
  closeModal();
  render();
}

function closeModal() {
  buyModal.style.display = "none";
}

/* ITEM INICIAL */
items.push({
  name: "Item de prueba",
  price: 100,
  qty: 10,
  img: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAFElEQVR42mNk+M9Qz0AEYBxVSF8AAF4fA8m4a9jLAAAAAElFTkSuQmCC"
});

render();
</script>

</body>
</html>
